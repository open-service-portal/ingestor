apiVersion: scaffolder.backstage.io/v1beta3
kind: Template
metadata:
  name: clusters-infrastructure-com
  title: Cluster
  description: Create and manage Cluster resources
  tags:
    - crossplane
    - infrastructure-com
    - infrastructure
    - cluster
  annotations:
    backstage.io/managed-by: xrd-transform
    backstage.io/managed-by-location: provider:XRDTemplateEntityProvider
    backstage.io/managed-by-origin-location: provider:XRDTemplateEntityProvider
    crossplane.io/xrd-name: clusters.infrastructure.com
    crossplane.io/xrd-group: infrastructure.com
spec:
  owner: platform-team
  type: crossplane-resource
  parameters:
    - title: Resource Configuration
      required:
        - name
        - region
      properties:
        name:
          title: Name
          type: string
          description: Name of the Cluster
          pattern: ^[a-z0-9]([-a-z0-9]*[a-z0-9])?$
        region:
          title: Region
          type: string
          description: Cloud region
          default: null
        nodeCount:
          title: NodeCount
          type: number
          description: Number of nodes
          default: 3
          minimum: 1
          maximum: 100
  steps:
    - id: workflow-info
      name: Direct Apply Workflow Information
      action: debug:log
      input:
        message: |
          ⚡ This template uses direct apply workflow:

          1. Creates your Cluster resource immediately in the cluster
          2. Registers the resource in the Backstage catalog

          Your resource will be created as soon as you click Create.
      output:
        text:
          - title: ⚡ Direct Apply Workflow
            content: >
              This template follows a **direct apply workflow** for immediate
              resource creation:


              **What happens when you click Create:**


              1. **Create Resource Immediately** 🚀
                 - Your Cluster resource is created directly in the Kubernetes cluster
                 - No approval required - resource is active immediately
                 - Applied to cluster: `rancher-desktop`

              2. **Register in Catalog** 📝
                 - The resource is automatically registered in the Backstage software catalog
                 - You can track and manage it through Backstage

              **✅ Important**: Your resource is **created immediately** without
              approval workflow.
    - id: create-resource
      name: Create Cluster
      action: kube:apply
      input:
        manifest: |
          apiVersion: infrastructure.com/v1alpha1
          kind: Cluster
          metadata:
            name: ${{ parameters.name }}
          spec: ${{ parameters }}
        namespaced: false
      output:
        text:
          - title: Resource Details
            content: |
              **Resource Created Successfully!** ✅

              **Resource Information:**
              - **Name**: `$`
              - **Type**: Cluster
              - **API Version**: infrastructure.com/v1alpha1
              - **Cluster**: rancher-desktop
              - **Scope**: Cluster-wide

              Your resource is now active in the cluster and ready to use.
    - id: register
      name: Register in Catalog
      action: catalog:register
      input:
        repoContentsUrl: ${{ steps.create-resource.output.repoContentsUrl }}
        catalogInfoPath: /catalog-info.yaml
      output:
        links:
          - title: View in Catalog
            icon: catalog
            url: ${{ steps['register'].output.entityRef }}
        text:
          - title: Catalog Registration
            content: |
              **Registered in Backstage Catalog** 📝

              Your Cluster resource has been added to the software catalog.
              You can now track, monitor, and manage it through Backstage.

