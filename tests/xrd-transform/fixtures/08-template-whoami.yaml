# XRD: WhoAmIApp (XR Definition)
# Purpose: Define a simple demo application with automatic domain configuration
# Restaurant Analogy: The "menu item" - what customers can order
apiVersion: apiextensions.crossplane.io/v2
kind: CompositeResourceDefinition
metadata:
  name: whoamiapps.openportal.dev
  labels:
    terasky.backstage.io/generate-form: "true"
    openportal.dev/version: "dev"  # CI/CD will replace with actual version
  annotations:
    # Standard Backstage metadata
    backstage.io/title: "Who Am I App"
    backstage.io/description: "Simple demo application with automatic domain configuration"
    backstage.io/owner: "platform-team"
    backstage.io/system: "demo-applications"
    backstage.io/lifecycle: "production"
    backstage.io/source-location: "url:https://github.com/open-service-portal/template-whoami"

    # Project metadata
    openportal.dev/tags: "demo,application"
    openportal.dev/version: "dev"

    # Crossplane
    crossplane.io/version: "v2.0"

    # GitHub
    github.com/project-slug: "open-service-portal/template-whoami"
spec:
  scope: Namespaced  # Crossplane v2 - XRs can be created in any namespace
  group: openportal.dev
  names:
    kind: WhoAmIApp
    plural: whoamiapps
  # Default composition when no selector is specified
  defaultCompositionRef:
    name: whoamiapp
  versions:
  - name: v1alpha1
    served: true
    referenceable: true
    schema:
      openAPIV3Schema:
        type: object
        properties:
          spec:
            type: object
            properties:
              name:
                type: string
                description: Application name (becomes subdomain, e.g., myapp.openportal.dev)
                pattern: "^[a-z0-9]([-a-z0-9]*[a-z0-9])?$"
                minLength: 1
                maxLength: 63
              replicas:
                type: integer
                description: Number of replicas
                default: 1
                minimum: 1
                maximum: 3
              image:
                type: string
                description: Container image to deploy
                default: "traefik/whoami:v1.10.1"
            required: []
          status:
            type: object
            properties:
              domain:
                type: string
                description: The configured domain for this deployment
              ready:
                type: boolean
                description: Whether the application is ready